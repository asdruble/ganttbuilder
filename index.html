<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Gantt Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-neutral-50">
    <div id="root"></div>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel" data-type="module" data-presets="react">
      import React, { useEffect, useMemo, useRef, useState } from "https://esm.sh/react@18";
      import ReactDOM from "https://esm.sh/react-dom@18/client";
      import { Plus, Trash2, Upload, ChevronDown, ChevronUp } from "https://esm.sh/lucide-react@0.276.0";

      // --- Types
      const defaultCategories = [
        { id: "discovery", name: "Discovery/Think", color: "#073a4b" },
        { id: "arquitetura", name: "Arquitetura", color: "#6aa5ab" },
        { id: "ingestao", name: "Ingestão & QA", color: "#6699a0" },
        { id: "integracao", name: "Integrações", color: "#4d8b92" },
        { id: "ativacao", name: "Ativação", color: "#3a7d85" },
        { id: "handoff", name: "Passagem Conhecimento", color: "#ef7d32" },
      ];

      function createStarterRows() {
        return [
          { id: crypto.randomUUID(), name: "Discovery (Think)", category: "discovery", start: 0, end: 1, type: "task" },
          { id: crypto.randomUUID(), name: "Arquitetura Lake & AEP", category: "arquitetura", start: 1, end: 3, type: "task" },
          { id: crypto.randomUUID(), name: "Ingestão e QA AEP", category: "ingestao", start: 1, end: 3, type: "task" },
          { id: crypto.randomUUID(), name: "RTCDP > Salesforce", category: "integracao", start: 1, end: 3, type: "task" },
          { id: crypto.randomUUID(), name: "Ativação RTCDP > Salesforce", category: "ativacao", start: 3, end: 5, type: "task" },
          { id: crypto.randomUUID(), name: "Passagem de Conhecimento", category: "handoff", start: 4, end: 4, type: "milestone" },
        ];
      }

      const STORAGE_KEY = "timeline-builder-saves";
      const LEGACY_KEY = "timeline-builder";

      const getTodayISO = () => new Date().toISOString().slice(0, 10);

      function createDefaultTimeline() {
        return {
          timelineMode: "periods",
          dateStart: getTodayISO(),
          dateInterval: "weeks",
          periodPrefix: "M",
          periodStartIndex: 0,
          periodCount: 7,
          labelColWidth: 320,
          rowHeight: 56,
          colWidth: 100,
          categories: defaultCategories.map((c) => ({ ...c })),
          rows: createStarterRows(),
          bgStripes: true,
        };
      }

      function TimelineBuilder() {
        const [periodPrefix, setPeriodPrefix] = useState("M");
        const [periodStartIndex, setPeriodStartIndex] = useState(0);
        const [periodCount, setPeriodCount] = useState(7);
        const [timelineMode, setTimelineMode] = useState("periods");
        const [dateStart, setDateStart] = useState(() => getTodayISO());
        const [dateInterval, setDateInterval] = useState("weeks");
        const [labelColWidth, setLabelColWidth] = useState(320);
        const [rowHeight, setRowHeight] = useState(56);
        const [colWidth, setColWidth] = useState(100);
        const [categories, setCategories] = useState(() => defaultCategories.map((c) => ({ ...c })));
        const [rows, setRows] = useState(() => createStarterRows());
        const [bgStripes, setBgStripes] = useState(true);
        const [showSettings, setShowSettings] = useState(true);
        const [showCategories, setShowCategories] = useState(true);
        const [savedCharts, setSavedCharts] = useState([]);
        const [currentChartId, setCurrentChartId] = useState(null);
        const [currentChartName, setCurrentChartName] = useState("");
        const [showLoadModal, setShowLoadModal] = useState(false);

        const gridRef = useRef(null);

        const weekFormatter = useMemo(() => new Intl.DateTimeFormat("en-US", { month: "short", day: "2-digit" }), []);
        const monthFormatter = useMemo(() => new Intl.DateTimeFormat("en-US", { month: "short" }), []);

        const periodLabels = useMemo(() => {
          const count = Math.max(0, periodCount);
          if (timelineMode === "dates") {
            let base = dateStart ? new Date(dateStart) : new Date();
            if (Number.isNaN(base.getTime())) base = new Date();
            return Array.from({ length: count }, (_, i) => {
              const current = new Date(base);
              if (dateInterval === "months") {
                current.setMonth(base.getMonth() + i);
                const id = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, "0")}`;
                return {
                  id: `month-${id}`,
                  label: monthFormatter.format(current).toUpperCase(),
                };
              }
              current.setDate(base.getDate() + i * 7);
              const id = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, "0")}-${String(current.getDate()).padStart(2, "0")}`;
              return {
                id: `week-${id}`,
                label: weekFormatter.format(current).toUpperCase(),
              };
            });
          }
          return Array.from({ length: count }, (_, i) => {
            const index = i + periodStartIndex;
            const label = `${periodPrefix}${index}`;
            return { id: `period-${index}`, label };
          });
        }, [timelineMode, periodCount, periodPrefix, periodStartIndex, dateStart, dateInterval, weekFormatter, monthFormatter]);

        useEffect(() => {
          setRows((rs) => {
            if (!rs.length) return rs;
            const maxIndex = periodLabels.length - 1;
            if (maxIndex < 0) {
              let changed = false;
              const reset = rs.map((r) => {
                if (r.start !== 0 || r.end !== 0) {
                  changed = true;
                  return { ...r, start: 0, end: 0 };
                }
                return r;
              });
              return changed ? reset : rs;
            }
            let changed = false;
            const next = rs.map((r) => {
              let start = Math.min(Math.max(0, r.start), maxIndex);
              let end = Math.min(Math.max(0, r.end), maxIndex);
              if (end < start) end = start;
              if (start !== r.start || end !== r.end) {
                changed = true;
                return { ...r, start, end };
              }
              return r;
            });
            return changed ? next : rs;
          });
        }, [periodLabels.length, setRows]);

        function addRowAt(index = rows.length) {
          setRows((r) => {
            const base = { id: crypto.randomUUID(), name: `Nova atividade ${r.length + 1}`, category: categories[0].id, start: 0, end: Math.min(1, periodCount - 1), type: "task" };
            const copy = [...r];
            copy.splice(index, 0, base);
            return copy;
          });
        }
        function addMilestoneAt(index = rows.length) {
          setRows((r) => {
            const base = { id: crypto.randomUUID(), name: `Novo marco ${r.length + 1}`, category: categories[0].id, start: 0, end: 0, type: "milestone" };
            const copy = [...r];
            copy.splice(index, 0, base);
            return copy;
          });
        }
        function removeRow(id) { setRows((r) => r.filter((x) => x.id !== id)); }

        function addCategory() {
          const id = `cat_${categories.length + 1}`;
          setCategories((c) => [...c, { id, name: `Categoria ${c.length + 1}`, color: randomColor() }]);
        }
        function removeCategory(id) {
          if (categories.length <= 1) return;
          setRows((rs) => rs.map((r) => (r.category === id ? { ...r, category: categories[0].id } : r)));
          setCategories((cs) => cs.filter((c) => c.id !== id));
        }
        function randomColor() {
          const h = Math.floor(Math.random() * 360);
          return `hsl(${h} 50% 45%)`;
        }

        function applyData(j = {}) {
          const defaults = createDefaultTimeline();
          const categoriesSource = Array.isArray(j.categories) && j.categories.length ? j.categories : defaults.categories;
          const normalizedCategories = categoriesSource.map((c, idx) => ({
            id: c.id ?? `category_${idx + 1}`,
            name: c.name ?? `Category ${idx + 1}`,
            color: c.color ?? randomColor(),
          }));
          const fallbackCategories = normalizedCategories.length ? normalizedCategories : defaults.categories;
          const categoryIds = new Set(fallbackCategories.map((c) => c.id));
          const fallbackCategoryId = fallbackCategories[0]?.id ?? defaults.categories[0]?.id ?? "";

          const rowsSource = Array.isArray(j.rows) ? j.rows : defaults.rows;
          const normalizedRows = rowsSource.map((r, idx) => {
            const start = Number.isFinite(r.start) ? r.start : 0;
            let end = Number.isFinite(r.end) ? r.end : start;
            if (end < start) end = start;
            const category = categoryIds.has(r.category) ? r.category : fallbackCategoryId;
            return {
              id: r.id ?? crypto.randomUUID(),
              name: r.name ?? `Activity ${idx + 1}`,
              category,
              start,
              end,
              type: r.type === "milestone" ? "milestone" : "task",
            };
          });

          setTimelineMode(j.timelineMode ?? defaults.timelineMode);
          setDateStart(j.dateStart ?? defaults.dateStart);
          setDateInterval(j.dateInterval ?? defaults.dateInterval);
          setPeriodPrefix(j.periodPrefix ?? defaults.periodPrefix);
          setPeriodStartIndex(j.periodStartIndex ?? defaults.periodStartIndex);
          setPeriodCount(j.periodCount ?? defaults.periodCount);
          setLabelColWidth(j.labelColWidth ?? defaults.labelColWidth);
          setRowHeight(j.rowHeight ?? defaults.rowHeight);
          setColWidth(j.colWidth ?? defaults.colWidth);
          setCategories(fallbackCategories);
          setRows(normalizedRows);
          setBgStripes(j.bgStripes === undefined ? defaults.bgStripes : Boolean(j.bgStripes));
        }

        function getCurrentTimelineData() {
          return {
            timelineMode,
            dateStart,
            dateInterval,
            periodPrefix,
            periodStartIndex,
            periodCount,
            labelColWidth,
            rowHeight,
            colWidth,
            categories,
            rows,
            bgStripes,
          };
        }

        function updateSavedCharts(updater) {
          setSavedCharts((prev) => {
            const next = updater(prev);
            const sorted = [...next].sort((a, b) => new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0));
            try {
              localStorage.setItem(STORAGE_KEY, JSON.stringify(sorted));
            } catch (err) {
              console.error(err);
            }
            return sorted;
          });
        }

        function handleSave(options = {}) {
          const { asCopy = false } = options;
          let name = currentChartName.trim();
          if (!name) {
            const suggested = currentChartName || "Untitled chart";
            const input = prompt("Give this chart a name:", suggested);
            if (!input) return;
            name = input.trim();
            if (!name) return;
          }
          const id = asCopy || !currentChartId ? crypto.randomUUID() : currentChartId;
          const payload = {
            id,
            name,
            updatedAt: new Date().toISOString(),
            data: getCurrentTimelineData(),
          };
          updateSavedCharts((charts) => {
            const filtered = charts.filter((item) => item.id !== id);
            return [...filtered, payload];
          });
          setCurrentChartId(id);
          setCurrentChartName(name);
        }

        function handleSaveAs() {
          handleSave({ asCopy: true });
        }

        function deleteSavedChart(id) {
          const chart = savedCharts.find((c) => c.id === id);
          if (chart && !confirm(`Delete "${chart.name}"?`)) return;
          updateSavedCharts((charts) => charts.filter((item) => item.id !== id));
          if (currentChartId === id) {
            setCurrentChartId(null);
          }
        }

        function loadChart(chart) {
          if (!chart || !chart.data) return;
          applyData(chart.data);
          setCurrentChartId(chart.id);
          setCurrentChartName(chart.name ?? "");
          setShowLoadModal(false);
        }

        function startNewChart() {
          const defaults = createDefaultTimeline();
          applyData(defaults);
          setCurrentChartId(null);
          setCurrentChartName("");
          setShowLoadModal(false);
        }

        function formatUpdatedAt(iso) {
          if (!iso) return "";
          const date = new Date(iso);
          return Number.isNaN(date.getTime()) ? "" : date.toLocaleString();
        }

        function exportJSON() {
          const data = getCurrentTimelineData();
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const baseName = currentChartName.trim() || "timeline";
          const safeName = baseName
            .replace(/[^a-z0-9\-_.\s]/gi, "")
            .trim()
            .replace(/\s+/g, "-")
            .toLowerCase() || "timeline";
          const a = document.createElement("a");
          a.href = url;
          a.download = `${safeName}.json`;
          a.click();
          URL.revokeObjectURL(url);
        }

        function importJSON(e) {
          const file = e.target.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const j = JSON.parse(String(reader.result));
              applyData(j);
            } catch (err) {
              alert("Arquivo inválido");
            }
          };
          reader.readAsText(file);
        }

        useEffect(() => {
          try {
            const stored = localStorage.getItem(STORAGE_KEY);
            let list = [];
            if (stored) {
              const parsed = JSON.parse(stored);
              if (Array.isArray(parsed)) {
                list = parsed
                  .filter((item) => item && typeof item === "object")
                  .map((item, idx) => {
                    const data = item.data && typeof item.data === "object" ? item.data : item;
                    return {
                      id: item.id ?? crypto.randomUUID(),
                      name: item.name ?? `Saved chart ${idx + 1}`,
                      updatedAt: item.updatedAt ?? new Date().toISOString(),
                      data,
                    };
                  })
                  .filter((item) => item.data && typeof item.data === "object");
              }
            }
            if (!list.length) {
              const legacy = localStorage.getItem(LEGACY_KEY);
              if (legacy) {
                try {
                  const data = JSON.parse(legacy);
                  if (data && typeof data === "object") {
                    list = [
                      {
                        id: crypto.randomUUID(),
                        name: "Migrated timeline",
                        updatedAt: new Date().toISOString(),
                        data,
                      },
                    ];
                  }
                } catch (err) {
                  console.error(err);
                }
                localStorage.removeItem(LEGACY_KEY);
              }
            }
            if (list.length) {
              const sorted = [...list].sort((a, b) => new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0));
              setSavedCharts(sorted);
              setShowLoadModal(true);
              try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(sorted));
              } catch (err) {
                console.error(err);
              }
            } else {
              startNewChart();
            }
          } catch (err) {
            console.error(err);
            startNewChart();
          }
        }, []);

        return (
          <div className="w-full min-h-screen bg-neutral-50 text-neutral-900">
            <div className="w-full mx-auto px-4 py-6 flex flex-col gap-4">
              <div className="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
                <div className="flex flex-col gap-2">
                  <h1 className="text-2xl font-bold">Project Timeline (Gantt-style) Builder</h1>
                  <div className="flex flex-col gap-1 sm:flex-row sm:items-center sm:gap-2">
                    <label className="text-xs font-medium uppercase tracking-wide text-neutral-500">Chart name</label>
                    <input
                      value={currentChartName}
                      onChange={(e)=>setCurrentChartName(e.target.value)}
                      placeholder="Untitled chart"
                      className="w-full sm:w-72 px-3 py-2 border border-neutral-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#073a4b]/40"
                    />
                  </div>
                </div>
                <div className="flex flex-wrap gap-2 justify-end">
                  <button onClick={()=>handleSave()} className="px-3 py-2 rounded-2xl shadow bg-white hover:bg-neutral-100">Save</button>
                  <button onClick={handleSaveAs} className="px-3 py-2 rounded-2xl shadow bg-white hover:bg-neutral-100">Save as copy</button>
                  <button onClick={()=>setShowLoadModal(true)} className="px-3 py-2 rounded-2xl shadow bg-white hover:bg-neutral-100">Load</button>
                  <button onClick={exportJSON} className="px-3 py-2 rounded-2xl shadow bg-white hover:bg-neutral-100">Export JSON</button>
                  <label className="px-3 py-2 rounded-2xl shadow bg-white hover:bg-neutral-100 cursor-pointer flex items-center gap-2">
                    <Upload className="w-4 h-4"/>
                    Import JSON
                    <input type="file" accept="application/json" onChange={importJSON} className="hidden" />
                  </label>
                </div>
              </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="p-4 rounded-2xl bg-white shadow">
                    <div className="flex items-center justify-between mb-3">
                      <h2 className="font-semibold">Timeline settings</h2>
                      <button onClick={()=>setShowSettings(s=>!s)} className="p-1 rounded-lg hover:bg-neutral-100">
                        {showSettings ? <ChevronUp className="w-4 h-4"/> : <ChevronDown className="w-4 h-4"/>}
                      </button>
                    </div>
                    {showSettings && (
                    <div className="flex flex-col gap-3">
                    <div className="flex items-center justify-between gap-2">
                      <label className="text-sm">Label type</label>
                      <select value={timelineMode} onChange={(e)=>setTimelineMode(e.target.value)} className="w-28 px-2 py-1 border rounded-lg">
                        <option value="periods">Periods</option>
                        <option value="dates">Dates</option>
                      </select>
                    </div>
                    <div className="flex items-center justify-between gap-2">
                      <label className="text-sm">{timelineMode === "periods" ? "Periods" : "Columns"}</label>
                      <input type="number" min={1} max={36} value={periodCount} onChange={(e)=>setPeriodCount(Number(e.target.value))} className="w-28 px-2 py-1 border rounded-lg"/>
                    </div>
                    {timelineMode === "periods" ? (
                      <>
                        <div className="flex items-center justify-between gap-2">
                          <label className="text-sm">Prefix</label>
                          <input value={periodPrefix} onChange={(e)=>setPeriodPrefix(e.target.value)} className="w-28 px-2 py-1 border rounded-lg"/>
                        </div>
                        <div className="flex items-center justify-between gap-2">
                          <label className="text-sm">Start index</label>
                          <input type="number" value={periodStartIndex} onChange={(e)=>setPeriodStartIndex(Number(e.target.value))} className="w-28 px-2 py-1 border rounded-lg"/>
                        </div>
                      </>
                    ) : (
                      <>
                        <div className="flex items-center justify-between gap-2">
                          <label className="text-sm">Start date</label>
                          <input type="date" value={dateStart} onChange={(e)=>setDateStart(e.target.value)} className="w-28 px-2 py-1 border rounded-lg"/>
                        </div>
                        <div className="flex items-center justify-between gap-2">
                          <label className="text-sm">Interval</label>
                          <select value={dateInterval} onChange={(e)=>setDateInterval(e.target.value)} className="w-28 px-2 py-1 border rounded-lg">
                            <option value="weeks">Weeks</option>
                            <option value="months">Months</option>
                          </select>
                        </div>
                      </>
                    )}
                    <div className="flex items-center justify-between gap-2">
                      <label className="text-sm">Label column (px)</label>
                      <input type="number" min={160} max={600} value={labelColWidth} onChange={(e)=>setLabelColWidth(Number(e.target.value))} className="w-28 px-2 py-1 border rounded-lg"/>
                    </div>
                      <div className="flex items-center justify-between gap-2">
                        <label className="text-sm">Row height (px)</label>
                        <input type="number" min={36} max={120} value={rowHeight} onChange={(e)=>setRowHeight(Number(e.target.value))} className="w-28 px-2 py-1 border rounded-lg"/>
                      </div>
                      <div className="flex items-center justify-between gap-2">
                        <label className="text-sm">Column min width (px)</label>
                        <input type="number" min={60} max={400} value={colWidth} onChange={(e)=>setColWidth(Number(e.target.value))} className="w-28 px-2 py-1 border rounded-lg"/>
                      </div>
                      <div className="flex items-center gap-2">
                        <input id="bgstripes" type="checkbox" checked={bgStripes} onChange={(e)=>setBgStripes(e.target.checked)} />
                        <label htmlFor="bgstripes" className="text-sm">Alternate row stripes</label>
                      </div>
                    </div>
                    )}
                  </div>

                  <div className="p-4 rounded-2xl bg-white shadow md:col-span-2">
                    <div className="flex items-center justify-between mb-3">
                      <h2 className="font-semibold">Categories</h2>
                      <button onClick={()=>setShowCategories(s=>!s)} className="p-1 rounded-lg hover:bg-neutral-100">
                        {showCategories ? <ChevronUp className="w-4 h-4"/> : <ChevronDown className="w-4 h-4"/>}
                      </button>
                    </div>
                    {showCategories && (
                    <>
                      <div className="flex flex-wrap gap-2 items-center mb-3">
                      {categories.map((c) => (
                        <div key={c.id} className="flex items-center gap-2 bg-neutral-100 rounded-xl px-2 py-1">
                          <input
                            className="w-36 px-2 py-1 text-sm border rounded-lg"
                            value={c.name}
                            onChange={(e)=>{
                              const val = e.target.value; setCategories((arr)=>arr.map(x=>x.id===c.id?{...x,name:val}:x));
                            }}
                          />
                          <input
                            type="color"
                            value={c.color}
                            onChange={(e)=>{
                              const val = e.target.value; setCategories((arr)=>arr.map(x=>x.id===c.id?{...x,color:val}:x));
                            }}
                          />
                          <button
                            className="p-1 rounded-lg hover:bg-red-50 text-red-600"
                            title="Remove category"
                            onClick={()=>removeCategory(c.id)}
                            disabled={categories.length<=1}
                          >
                            <Trash2 className="w-4 h-4"/>
                          </button>
                        </div>
                      ))}
                      <button onClick={addCategory} className="px-3 py-2 rounded-xl bg-white shadow hover:bg-neutral-100 flex items-center gap-2"><Plus className="w-4 h-4"/> Add category</button>
                      </div>
                      <div className="text-xs text-neutral-600">Tip: edit names/colors. You can delete categories; items using it are reassigned to the first category.</div>
                    </>
                    )}
                  </div>
                </div>

                <div className="rounded-2xl bg-white shadow overflow-x-auto">
                  <div className="w-full">
                  <div className="p-3 flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <button onClick={()=>addRowAt()} className="px-3 py-2 rounded-xl bg-white shadow hover:bg-neutral-100 flex items-center gap-2"><Plus className="w-4 h-4"/> Add activity</button>
                      <button onClick={()=>addMilestoneAt()} className="px-3 py-2 rounded-xl bg-white shadow hover:bg-neutral-100 flex items-center gap-2"><Plus className="w-4 h-4"/> Add milestone</button>
                    </div>
                    <span className="text-xs text-neutral-500">Arraste para mover/redimensionar. Clique direito para trocar a categoria. <b>Duplo clique</b> no rótulo ou na barra para excluir.</span>
                  </div>
                  <div ref={gridRef} className="px-6 pb-6">
                      <TimelinePreview
                        rows={rows}
                        setRows={setRows}
                        categories={categories}
                        labels={periodLabels}
                        labelColWidth={labelColWidth}
                        rowHeight={rowHeight}
                        bgStripes={bgStripes}
                        onAddRowAt={addRowAt}
                        onAddMilestoneAt={addMilestoneAt}
                        onRemoveRow={removeRow}
                        columnWidth={colWidth}
                      />
            </div>
            {showLoadModal && (
              <div className="fixed inset-0 z-50 flex items-center justify-center px-4 py-6 bg-black/40">
                <div className="relative w-full max-w-xl rounded-3xl bg-white p-6 shadow-2xl">
                  <div className="mb-4 flex items-center justify-between gap-4">
                    <h2 className="text-lg font-semibold text-neutral-900">Saved charts</h2>
                    <button
                      onClick={()=>setShowLoadModal(false)}
                      className="text-sm font-medium text-neutral-500 hover:text-neutral-700"
                    >
                      Close
                    </button>
                  </div>
                  {savedCharts.length ? (
                    <div className="flex max-h-[50vh] flex-col gap-3 overflow-y-auto pr-1">
                      {savedCharts.map((chart) => {
                        const updatedAt = formatUpdatedAt(chart.updatedAt);
                        return (
                          <div
                            key={chart.id}
                            className="flex flex-col gap-3 rounded-2xl border border-neutral-200 p-3 sm:flex-row sm:items-center sm:justify-between"
                          >
                            <div className="flex flex-col gap-1">
                              <div className="flex items-center gap-2">
                                <span className="font-medium text-neutral-900">{chart.name || "Untitled chart"}</span>
                                {chart.id === currentChartId && (
                                  <span className="rounded-full bg-[#073a4b]/10 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-[#073a4b]">
                                    Current
                                  </span>
                                )}
                              </div>
                              {updatedAt && (
                                <span className="text-xs text-neutral-500">Last updated {updatedAt}</span>
                              )}
                            </div>
                            <div className="flex items-center justify-end gap-2">
                              <button
                                onClick={()=>loadChart(chart)}
                                className="rounded-xl bg-[#073a4b] px-3 py-2 text-sm font-medium text-white shadow hover:bg-[#052835]"
                              >
                                Load
                              </button>
                              <button
                                onClick={()=>deleteSavedChart(chart.id)}
                                className="flex items-center gap-1 rounded-xl border border-red-200 px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50"
                              >
                                <Trash2 className="h-4 w-4" /> Delete
                              </button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <div className="rounded-2xl border border-dashed border-neutral-300 p-6 text-center text-sm text-neutral-500">
                      You don't have any saved charts yet. Create a new chart to get started.
                    </div>
                  )}
                  <div className="mt-6 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                    <button
                      onClick={startNewChart}
                      className="w-full rounded-xl bg-[#3a7d85] px-4 py-2 text-sm font-medium text-white shadow hover:bg-[#2d6066] sm:w-auto"
                    >
                      Create new chart
                    </button>
                    <button
                      onClick={()=>setShowLoadModal(false)}
                      className="w-full rounded-xl border border-neutral-200 px-4 py-2 text-sm font-medium text-neutral-700 hover:bg-neutral-100 sm:w-auto"
                    >
                      Close
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>

              <div className="text-xs text-neutral-500 pt-4">Para exportar imagem, tire um screenshot da prévia. Você ainda pode Exportar/Importar JSON para salvar e reabrir edições.</div>
            </div>
          </div>
        );
      }

        function TimelinePreview({ rows, setRows, categories, labels, labelColWidth, rowHeight, bgStripes, onAddRowAt, onAddMilestoneAt, onRemoveRow, columnWidth }) {
          const cols = labels.length;
          const gridTemplate = ` ${labelColWidth}px repeat(${cols}, minmax(${columnWidth}px, 1fr))`;
        const containerRef = useRef(null);
        const [menu, setMenu] = useState({ open:false, x:0, y:0, rowId:null });
        const [drag, setDrag] = useState(null);

        useEffect(()=>{
          function onMove(e){
            if(!drag || !containerRef.current) return;
            const rect = containerRef.current.getBoundingClientRect();
            const usable = rect.width - 0;
            const x = Math.max(0, Math.min(e.clientX - rect.left, usable));
            const per = usable / cols;
            const deltaCols = Math.round((x - drag.startX) / per);
            setRows((rs)=>rs.map((r)=>{
              if(r.id !== drag.rowId) return r;
              if(drag.type === "move"){
                let ns = Math.max(0, Math.min(drag.startStart + deltaCols, cols-1));
                let ne = ns + (drag.startEnd - drag.startStart);
                if(ne > cols-1){ ne = cols-1; ns = ne - (drag.startEnd - drag.startStart); }
                return { ...r, start: ns, end: ne };
              }
              if(drag.type === "left"){
                let ns = Math.max(0, Math.min(drag.startStart + deltaCols, r.end));
                return { ...r, start: Math.min(ns, r.end) };
              }
              if(drag.type === "right"){
                let ne = Math.max(r.start, Math.min(drag.startEnd + deltaCols, cols-1));
                return { ...r, end: Math.max(ne, r.start) };
              }
              return r;
            }));
          }
          function onUp(){ setDrag(null); }
          window.addEventListener('mousemove', onMove);
          window.addEventListener('mouseup', onUp);
          return ()=>{ window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
        }, [drag, cols, setRows]);

        return (
          <div className="w-full" onContextMenu={(e)=>e.preventDefault()}>
            <div className="grid" style={{ gridTemplateColumns: gridTemplate }}>
              <div></div>
              {labels.map((label, idx) => (
                <div key={label.id ?? idx} className="relative flex items-center justify-center">
                  <div className="bg-[#073a4b] text-white px-3 py-1 rounded-b-xl text-sm font-semibold shadow">{label.label}</div>
                </div>
              ))}
            </div>

            <div className="mt-2 grid" style={{ gridTemplateColumns: gridTemplate }}>
              {rows.map((r, idx) => {
                const cat = categories.find((c)=>c.id===r.category) || categories[0];
                const startLabel = labels[r.start]?.label;
                const endLabel = labels[r.end]?.label;
                return (
                  <React.Fragment key={r.id}>
                    <div
                      className={`flex items-center pl-4 pr-3 text-sm font-medium ${bgStripes && idx % 2 === 1 ? "bg-neutral-100" : "bg-neutral-200"}`}
                      style={{ height: rowHeight }}
                      onDoubleClick={()=>{
                        if(confirm('Delete this activity?')) onRemoveRow(r.id);
                      }}
                    >
                      <span contentEditable suppressContentEditableWarning onBlur={(e)=>{
                        const name = e.currentTarget.textContent || "";
                        setRows((rs)=>rs.map((x)=>x.id===r.id?{...x,name}:x));
                      }}>{r.name}</span>
                    </div>

                    {Array.from({ length: cols }, (_, ci) => (
                      <div key={ci} className={`${bgStripes && idx % 2 === 1 ? "bg-neutral-50" : "bg-neutral-100"} relative`} style={{ height: rowHeight }}>
                        <div className="absolute right-0 top-0 h-full border-r border-dashed border-neutral-300" />
                      </div>
                    ))}

                    <div className="col-start-2 col-end-[-1] relative" style={{ height: 0 }}>
                      <div
                        ref={idx===0?containerRef:null}
                        className="absolute left-0 top-[-1px] h-[1px] w-full"
                      />
                      {r.type === "milestone" ? (
                        <div
                          className="absolute group cursor-grab active:cursor-grabbing"
                          onMouseDown={(e)=>{
                            const rect = e.currentTarget.parentElement.getBoundingClientRect();
                            setDrag({ rowId:r.id, type:"move", startX: e.clientX - rect.left, startStart: r.start, startEnd: r.end });
                          }}
                          onDoubleClick={()=>{ if(confirm('Delete this activity?')) onRemoveRow(r.id); }}
                          onContextMenu={(e)=>{
                            e.preventDefault();
                            setMenu({ open:true, x:e.clientX, y:e.clientY, rowId:r.id });
                          }}
                          style={{
                            left: `calc((100% / ${cols}) * ${r.start + 0.5})`,
                            top: -rowHeight + rowHeight * 0.15,
                            width: rowHeight * 0.7,
                            height: rowHeight * 0.7,
                            background: cat.color,
                            transform: "translate(-50%, 0) rotate(45deg)",
                            boxShadow: "0 4px 10px rgba(0,0,0,0.15)",
                          }}
                          title={startLabel ? `${r.name} • ${startLabel}` : r.name}
                        />
                      ) : (
                        <div
                          className="absolute group cursor-grab active:cursor-grabbing"
                          onMouseDown={(e)=>{
                            const rect = e.currentTarget.parentElement.getBoundingClientRect();
                            setDrag({ rowId:r.id, type:"move", startX: e.clientX - rect.left, startStart: r.start, startEnd: r.end });
                          }}
                          onDoubleClick={()=>{ if(confirm('Delete this activity?')) onRemoveRow(r.id); }}
                          onContextMenu={(e)=>{
                            e.preventDefault();
                            setMenu({ open:true, x:e.clientX, y:e.clientY, rowId:r.id });
                          }}
                          style={{
                            left: `calc((100% / ${cols}) * ${r.start})`,
                            width: `calc((100% / ${cols}) * ${r.end - r.start + 1})`,
                            top: -rowHeight + rowHeight * 0.15,
                            height: rowHeight * 0.7,
                            background: cat.color,
                            borderRadius: 9999,
                            boxShadow: "0 4px 10px rgba(0,0,0,0.15)",
                          }}
                          title={`${r.name}${startLabel ? ` • ${startLabel}` : ""}${endLabel && endLabel !== startLabel ? ` → ${endLabel}` : ""}`}
                        >
                          <div
                            className="absolute left-0 top-0 h-full w-2 cursor-ew-resize bg-black/0 hover:bg-black/10 rounded-l-full"
                            onMouseDown={(e)=>{
                              const rect = e.currentTarget.parentElement.parentElement.getBoundingClientRect();
                              setDrag({ rowId:r.id, type:"left", startX: e.clientX - rect.left, startStart: r.start, startEnd: r.end });
                              e.stopPropagation();
                            }}
                          />
                          <div
                            className="absolute right-0 top-0 h-full w-2 cursor-ew-resize bg-black/0 hover:bg-black/10 rounded-r-full"
                            onMouseDown={(e)=>{
                              const rect = e.currentTarget.parentElement.parentElement.getBoundingClientRect();
                              setDrag({ rowId:r.id, type:"right", startX: e.clientX - rect.left, startStart: r.start, startEnd: r.end });
                              e.stopPropagation();
                            }}
                          />
                        </div>
                      )}
                    </div>
                  </React.Fragment>
                );
              })}
            </div>

            {menu.open && (
              <div
                className="fixed z-50 bg-white border shadow-lg rounded-xl p-2 text-sm min-w-[220px]"
                style={{ left: menu.x + 2, top: menu.y + 2 }}
                onMouseLeave={()=>setMenu({ open:false, x:0, y:0, rowId:null })}
              >
                <div className="px-2 py-1 text-xs text-neutral-500">Set category</div>
                {categories.map((c)=> (
                  <button key={c.id} onClick={()=>{ setRows((rs)=>rs.map((r)=>r.id===menu.rowId?{...r, category:c.id}:r)); setMenu({ open:false, x:0, y:0, rowId:null }); }} className="w-full flex items-center gap-2 px-2 py-1 rounded-lg hover:bg-neutral-100">
                    <span className="inline-block w-3 h-3 rounded-full" style={{ background:c.color }} /> {c.name}
                  </button>
                ))}
                <div className="h-px my-1 bg-neutral-200" />
                <button className="w-full px-2 py-1 rounded-lg hover:bg-neutral-100 text-left" onClick={()=>{ onAddRowAt(rows.findIndex(r=>r.id===menu.rowId)+1); setMenu({ open:false, x:0, y:0, rowId:null }); }}>Add activity below</button>
                <button className="w-full px-2 py-1 rounded-lg hover:bg-neutral-100 text-left" onClick={()=>{ onAddMilestoneAt(rows.findIndex(r=>r.id===menu.rowId)+1); setMenu({ open:false, x:0, y:0, rowId:null }); }}>Add milestone below</button>
                <button className="w-full px-2 py-1 rounded-lg hover:bg-neutral-100 text-left text-red-600" onClick={()=>{ onRemoveRow(menu.rowId); setMenu({ open:false, x:0, y:0, rowId:null }); }}>Delete activity</button>
              </div>
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<TimelineBuilder />);
    </script>
  </body>
</html>
